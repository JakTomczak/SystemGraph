{% extends 'base.html' %}

{% block title %}Edit edge{% endblock %}

{% load widget_tweaks %}

{% block content %}
	<div class="maindiv mediumpadd">
		<form method="post" id="edit-edge-form">
			<input type="hidden" id="hidden_action" value="" name="action">
			<div class="internal-menu space-between sidepadd">
				<h4>Edycja krawędzi</h4>
				<button id="save_button" name="save_all" class="btn btn-secondary sgbutton">Zapisz&nbspbez kompilacji</button>
				<button type="button" id="compile_all" name="compile" class="btn btn-primary sgbutton">Zapisz i kompiluj</button>
				{% if predecessor %}<a role="button" id="return_button" class="btn btn-secondary sgbutton" href="{% url 'edit_vertex' vertex_id=predecessor %}">Powrót</a>{% endif %}
				<button type="button" id="delete_edge" name="delete" class="btn btn-warning sgbutton">Usuń krawędź</button>
			</div>
			{% csrf_token %}
			{% for hidden in form.hidden_fields %}
				{{ hidden }}
			{% endfor %}
			<div class="distinctarea border border-primary rounded medium-margin">
				<h5>Początek (wierzchołek wyjściowy)</h5>
				{% include 'common/vertex_singleframe.html' with this_vertex=predecessor %}
			</div>
			<div class="distinctarea border border-primary rounded medium-margin">
				<h5>Koniec (wierzchołek docelowy)</h5>
				{% include 'common/vertex_singleframe_in_choosing.html' with this_vertex=dummy not_chosen=1 %}
				<span id="not_chosen_span">(nie wybrano)<span>
			</div>
			<!--
			<div class="form-group">
				<h5>Początek (wierzchołek wyjściowy): </h5>
				<a href="{% url 'edit_vertex' vertex_id=predecessor.vertex_id %}" class="fancy-a">{{ predecessor }}</a>
			</div>
			<div class="distinctarea border border-primary rounded medium-margin">
				<div>
					<h5 for="{{ form.successor.id_for_label }}" style="text-align: left">Koniec (wierzchołek docelowy): </h5>
					{% render_field form.successor class="form-control" style="min-width:150px" placeholder=form.successor.label %}
					{% for error in form.successor.errors %}
						<span class="help-block">{{ error }}</span>
					{% endfor %}
				</div>
				<div class="flexonwidth nowrap" style="flex:1;">
					<small for="{{ form.limituser.id_for_label }}" class="inline_desc">Ogranicz autora:</small>
					{% render_field form.limituser class="form-control smallformfield" style="min-width:70px;" onChange="form.submit();" placeholder=form.limituser.label %}
					<small for="{{ form.limitdiscipline.id_for_label }}" class="inline_desc">Ogranicz dyscyplinę:</small>
					{% render_field form.limitdiscipline class="form-control smallformfield" style="min-width:70px; padding-bottom:0; padding-top:0" onChange="form.submit();" placeholder=form.limitdiscipline.label %}
				</div>
			</div>
			-->
			<div class="flexonwidth" style="width: 100%;">
				<div class="distinctarea border border-primary rounded medium-margin" style="flex:1; flex-grow: 3;">
					<div class="form-group" style="display: block;">
						<h5 for="{{ form.preamble.id_for_label }}" style="text-align: left">Preambuła: </h5>
						{% render_field form.preamble class="form-control" style="min-width:150px" placeholder=form.preamble.label %}
						{% for error in form.preamble.errors %}
							<span class="help-block">{{ error }}</span>
						{% endfor %}
						<a href="{% url 'new_preamble' %}">Utworzyć nową?</a>
					</div>
					<div class="form-group" style="display: block;">
						<h5 for="{{ form.content.id_for_label }}" style="text-align: left">Treść (nadpisująca domyślny opis wierzchołka):</h5>
						{% render_field form.content class="form-control" rows="3" style="min-width:150px" placeholder=form.content.label %}
						{% for error in form.content.errors %}
							<span class="help-block">{{ error }}</span>
						{% endfor %}
					</div>
				</div>
				<div class="distinctarea border border-primary rounded medium-margin" style="flex-grow: 1;">
					<span style="text-align: center;">Log kompilacji</span>
					<div style="width: 100%; height: 100%;">
						<textarea readonly id="js_comms" style="width: 100%; height: 100%;"></textarea>
					</div>
				</div>
			</div>
		</form>
	</div>
{% endblock %}
{% block javascript %}
	<script>
	function check_for_messages(what) {
		document.getElementById("js_comms").value += 'Compilation begun';
		var still = true;
		var m = [];
		var len = 0;
		var i = 0;
		while (still) {
			still = false;
			$.ajax({
				url: '{% url "check_compilation" %}',
				type: 'post',
				async: false,
				data: {
					'object': '{{ edge_id }}',
					'object_type': 'edge'
				},
				dataType: 'json',
				success: function (data) {
					still = data.still;
					for (var j = len; j < data.messages.length; j++) {
						document.getElementById("js_comms").value += "\n" + data.messages[j];
						len++;
					}
					m = data.messages;
				},
				failure: function(data) { 
					still = false;
				}
			});
		}
		document.getElementById("js_comms").value += "\n"
	}
	$(document).ready(function() {
		document.getElementById("compile_all").addEventListener('click', function(event) {
			$.ajax({
				url: '{% url "compile_edge" edge_id=edge_id %}',
				type: 'post',
				data: {
					'content': $("#id_content").val()
				},
				dataType: 'json'
			});
			$.ajax({
				url: '{% url "save_edge" edge_id=edge_id %}',
				type: 'post',
				data: {
					'content': $("#id_content").val(),
					'successor': $("#id_successor").val(),
					'preamble': $("#id_preamble").val(),
				},
				dataType: 'json'
			});
			check_for_messages();
		});
	
		document.getElementById("delete_edge").addEventListener('click', function(event) {
			var choice = confirm('Czy na pewno? \nKrawędź zostanie usunięta na stałe.');
			if (choice) {
				document.getElementById("hidden_action").value += ',delete';
				document.getElementById("edit-edge-form").submit();
			}
		});
		{% if predecessor %}tippy('#return_button', {content: 'Powrót do edycji wierzchołka',});{% endif %}
    });
	</script>
{% endblock %}